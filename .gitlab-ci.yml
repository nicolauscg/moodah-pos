stages:
  - build
  - test
  - release

build frontend:
  image: node:10.16.3-alpine
  stage: build
  script:
    - cd frontend
    - npm install
    - npm build
  artifacts:
    name: "frontend-$CI_COMMIT_REF_NAME"
    paths:
      - frontend/build
      - frontend/node_modules
      - frontend/src/generated-models.tsx
  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml

test frontend:
  image: node:10.16.3-alpine
  stage: test
  script:
    - cd frontend
    - npm run test -- --coverage
  dependencies:
    - build frontend
  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml

release dev frontend:
  image: docker:19.03.0
  stage: release
  tags:
    - docker
  services:
    - name: docker:19.03.0-dind
      entrypoint: ["env", "-u", "DOCKER_HOST"]
      command: ["dockerd-entrypoint.sh"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker pull $CI_REGISTRY_IMAGE/dev/frontend:latest || true
    - docker build 
        --cache-from $CI_REGISTRY_IMAGE/dev/frontend:latest 
        --tag $CI_REGISTRY_IMAGE/dev/frontend:latest ./frontend
    - docker push $CI_REGISTRY_IMAGE/dev/frontend:latest
  environment:
    name: development
  when: manual
  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml
  except:
    - master
    - staging

release stag frontend:
  image: docker:19.03.0
  stage: release
  tags:
    - docker
  services:
    - name: docker:19.03.0-dind
      entrypoint: ["env", "-u", "DOCKER_HOST"]
      command: ["dockerd-entrypoint.sh"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker pull $CI_REGISTRY_IMAGE/stag/frontend:latest || true
    - docker build 
        --cache-from $CI_REGISTRY_IMAGE/stag/frontend:latest 
        --tag $CI_REGISTRY_IMAGE/stag/frontend:latest ./frontend
    - docker push $CI_REGISTRY_IMAGE/stag/frontend:latest
  environment:
    name: staging
  only:
    refs:
      - staging
    changes:
      - frontend/**/*
      - .gitlab-ci.yml

release prod frontend:
  image: docker:19.03.0
  stage: release
  tags:
    - docker
  services:
    - name: docker:19.03.0-dind
      entrypoint: ["env", "-u", "DOCKER_HOST"]
      command: ["dockerd-entrypoint.sh"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker pull $CI_REGISTRY_IMAGE/prod/frontend:latest || true
    - docker build 
        --cache-from $CI_REGISTRY_IMAGE/prod/frontend:latest 
        --tag $CI_REGISTRY_IMAGE/prod/frontend:latest ./frontend
    - docker push $CI_REGISTRY_IMAGE/prod/frontend:latest
  environment:
    name: production
  only:
    refs:
      - master
    changes:
      - frontend/**/*
      - .gitlab-ci.yml
